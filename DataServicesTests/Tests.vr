Using System
Using System.Text
Using System.Data
Using System.Collections 
Using System.Collections.Generic
Using Microsoft.VisualStudio.TestTools.UnitTesting
Using System.IO 
Using ASNA.DataGate.Client
Using NewtonSoft.Json
Using System.Diagnostics
Using ClosedXMl.Excel
Using System.Web.UI.WebControls 

// Set reference to Microsoft.VisualStudio.QualityTools.UnitTestFramework

// DclNamespace DataServicesTests

// Project template location:
// "C:\Users\Roger\Documents\Visual Studio 2012\My Exported Templates\AVR unit test project.zip"

BegClass Tests Access(*Public) Attributes(TestClass())

    //DclConst DBName Value("*Public/CYPRESS") 
    DclConst DBName Value("*Public/DG NET Local") 

    DclFld db       Type(AdgConnection) Shared(*Yes)

    BegSr OpenDB Access(*Public) Attributes(ClassInitialize()) Shared(*Yes)
        DclSrParm context Type(Microsoft.VisualStudio.TestTools.UnitTesting.TestContext)

        Tests.db = *New AdgConnection(DBName) 
        Tests.db.Open()

        // Give the connection time to spin up. 
        Sleep 10000
    EndSr

    BegSr CloseDB Access(*Public) Attributes(ClassCleanup()) Shared(*Yes)
      Tests.db.Close()
    EndSr

    BegSr PagedQueryToDataTable Attributes(TestMethod()) Access(*Public)       
        DclFld Query         Type(ASNA.Helpers.DataServices.QueryDriver) New(db)
        DclFld dt            Type(DataTable)

        Query.Args.Inputs.Library      = "examples"
        Query.Args.Inputs.File         = "CmastNewL1"
        Query.Args.Inputs.FieldsList   = "CMCUSTNO,CMNAME,CMADDR1,CMCITY,CMSTATE,CMPOSTCODE"
        Query.Args.Inputs.Rows         = 12
        Query.Args.Inputs.QueryType    = ASNA.Helpers.DataServices.QueryType.Paged
        Query.Args.Inputs.QueryFields.Add(*New ASNA.Helpers.DataServices.QueryField("CMCUSTNO",0))
                
        dt = Query.Exec() *As DataTable
        Assert.AreEqual(dt.Rows.Count, Query.Args.Inputs.Rows) 
    EndSr 

    BegSr PagedQueryToDataTable2 Attributes(TestMethod()) Access(*Public)
        DclFld Query         Type(ASNA.Helpers.DataServices.QueryDriver) New(db)
        DclFld dt            Type(DataTable)
        DclFld ArgsJson      Type(*String) 

        Query.Args.Inputs.Library      = "examples"
        Query.Args.Inputs.File         = "CmastNewL1"
        Query.Args.Inputs.FieldsList   = "CMCUSTNO,CMNAME,CMADDR1,CMCITY,CMSTATE,CMPOSTCODE"
        Query.Args.Inputs.Rows         = 12
        Query.Args.Inputs.QueryType    = ASNA.Helpers.DataServices.QueryType.Paged
        Query.Args.Inputs.QueryFields.Add(*New ASNA.Helpers.DataServices.QueryField("CMCUSTNO",0))
                
        dt = Query.Exec() *As DataTable

        ArgsJson = JsonConvert.SerializeObject(Query.Args,Formatting.Indented)
        File.WriteAllText("c:\users\roger\documents\testing\PagedQueryToDataTable2-Args.json",ArgsJson)
        Assert.AreEqual(dt.Rows.Count, Query.Args.Inputs.Rows) 
    EndSr 

    BegSr PagedQueryToJson Attributes(TestMethod()) Access(*Public)
        DclFld Query         Type(ASNA.Helpers.DataServices.QueryDriver) New(db)
        DclFld Json          Type(*String)
        DclFld ArgsJson      Type(*String) 

        Query.Args.Inputs.Library      = "examples"
        Query.Args.Inputs.File         = "CmastNewL1"
        Query.Args.Inputs.FieldsList   = "CMCUSTNO,CMNAME,CMADDR1,CMCITY,CMSTATE,CMPOSTODE"
        Query.Args.Inputs.Rows         = 12
        Query.Args.Inputs.QueryType    = ASNA.Helpers.DataServices.QueryType.Paged
        Query.Args.Inputs.Options.Add("indentJson", *True) 
        Query.Args.Inputs.QueryFields.Add(*New ASNA.Helpers.DataServices.QueryField("CMCUSTNO",0))
        Query.OverrideAdapter(*New ASNA.Helpers.DataServices.ToJsonAdapter(Query.Args)) 
        
        Json = Query.Exec() *As *String

        ArgsJson = JsonConvert.SerializeObject(Query.Args,Formatting.Indented)
        File.WriteAllText("c:\users\roger\documents\testing\PagedQueryToJson-args.json",ArgsJson)

        File.WriteAllText("c:\users\roger\documents\testing\PagedQueryToJson.json",Json)
    EndSr 

    BegSr ExportToExcel Attributes(TestMethod()) Access(*Public)
        DclFld Query        Type(ASNA.Helpers.DataServices.QueryDriver) New(db)
        DclFld ExcelAdapter Type(ASNA.Helpers.DataServices.ToExcelAdapter)
        DclFld ArgsJson     Type(*String) 

        DclConst EXCEL_FILE Value("C:\Users\Roger\Documents\testing\table-cleared.xlsx")
                 
        Query.Args.Inputs.Library    = "examples"
        Query.Args.Inputs.File       = "CMastNewL2"
        Query.Args.Inputs.FieldsList = "CMCUSTNO:Number,CMNAME:Name,CMADDR1:Address,CMCITY:City,CMSTATE:State,CMPOSTCODE:Zip code"
        Query.Args.Inputs.Rows       = 1000
        Query.Args.Inputs.QueryType  = ASNA.Helpers.DataServices.QueryType.Paged
        Query.Args.Inputs.QueryFields.Add(*New ASNA.Helpers.DataServices.QueryField("CMCUSTNO",0))
        Query.Args.Inputs.Options.Add("heading","Customer Listing")
        Query.Args.Inputs.Options.Add("worksheetName","Customers")

        ExcelAdapter = *New ASNA.Helpers.DataServices.ToExcelAdapter(Query.Args) 
        Query.OverrideAdapter(ExcelAdapter)

        File.Delete(EXCEL_FILE)
        Query.Exec() 
        ExcelAdapter.SaveToLocalFile(EXCEL_FILE)

        ArgsJson = JsonConvert.SerializeObject(Query.Args,Formatting.Indented)
        File.WriteAllText("c:\users\roger\documents\testing\Excel-args.json",ArgsJson)

        Assert.IsTrue(File.Exists(EXCEL_FILE)) 
    EndSr

    BegSr ExportListItemArray Attributes(TestMethod()) Access(*Public)
        DclFld   Query        Type(ASNA.Helpers.DataServices.QueryDriver) New(db)
        DclArray ListItems    Type(ListItem) Rank(1)
                 
        Query.Args.Inputs.Library    = "devo"
        Query.Args.Inputs.File       = "States"
        Query.Args.Inputs.FieldsList = "State:text,Abbrev:value"
        Query.Args.Inputs.Rows       = 1000
        Query.Args.Inputs.QueryType  = ASNA.Helpers.DataServices.QueryType.Simple
        Query.Args.Inputs.Query      = "STATE >= 'A'"
        Query.Args.Inputs.QueryFields.Add(*New ASNA.Helpers.DataServices.QueryField("STATE",""))
        Query.OverrideAdapter(*New ASNA.Helpers.DataServices.ToLisItemArrayAdapter(Query.Args))

        ListItems = Query.Exec() *As ListItem[]
        Console.WriteLine("hello")
        If (Query.Args.Error.ErrorException = *Nothing)
            Assert.AreEqual(ListItems.Length,Convert.ToInt32(59))
        Else 
            Assert.Fail(Query.Args.Error.ErrorMessage)
        EndIf 
    EndSr

EndClass
